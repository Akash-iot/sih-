<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ETHER-EYE | Advanced Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api-client.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); 
            color: #fff; min-height: 100vh; display: flex; 
        }
        
        .sidebar { 
            width: 280px; background: rgba(42, 42, 60, 0.95); backdrop-filter: blur(20px);
            padding: 25px; height: 100vh; position: fixed; overflow-y: auto; 
            box-shadow: 2px 0 20px rgba(0,0,0,0.3);
        }
        .sidebar .logo { 
            font-size: 24px; font-weight: bold; color: #6b48ff; margin-bottom: 30px; cursor: pointer; 
        }
        .sidebar .logo::before { content: "üìà"; margin-right: 12px; }
        
        .sidebar h3 { 
            font-size: 14px; text-transform: uppercase; margin-bottom: 15px; 
            color: #888; font-weight: 600; 
        }
        .sidebar ul { list-style: none; margin-bottom: 30px; }
        .sidebar ul li { margin-bottom: 8px; }
        .sidebar ul li a { 
            display: flex; align-items: center; color: #b0b0c0; text-decoration: none; 
            padding: 12px 15px; border-radius: 8px; transition: all 0.3s ease; 
        }
        .sidebar ul li a:hover, .sidebar ul li a.active { 
            background: rgba(107, 72, 255, 0.2); color: #fff; transform: translateX(5px); 
        }
        .sidebar ul li a::before { margin-right: 12px; font-size: 16px; }
        .sidebar ul li a.dashboard::before { content: "üìä"; }
        .sidebar ul li a.wallets::before { content: "üëõ"; }
        .sidebar ul li a.traces::before { content: "üîç"; }
        .sidebar ul li a.analytics::before { content: "üìà"; }
        .sidebar ul li a.explorer::before { content: "üåê"; }
        .sidebar ul li a.spider-map::before { content: "üï∏Ô∏è"; }
        .sidebar ul li a.settings::before { content: "‚öôÔ∏è"; }
        
        .content { margin-left: 280px; flex: 1; padding: 25px; }
        
        .header { 
            background: rgba(42, 42, 60, 0.95); backdrop-filter: blur(20px); 
            padding: 25px; border-radius: 15px; margin-bottom: 25px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
        }
        .header h1 { font-size: 28px; font-weight: 700; color: #6b48ff; }
        
        .filters { display: flex; gap: 15px; align-items: center; }
        .filter-btn { 
            padding: 12px 20px; border: 2px solid rgba(107, 72, 255, 0.3); 
            border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: #fff; 
            cursor: pointer; transition: all 0.3s ease; font-weight: 600;
        }
        .filter-btn:hover, .filter-btn.active { 
            background: linear-gradient(135deg, #6b48ff 0%, #5a3de6 100%); 
            border-color: #6b48ff; transform: translateY(-2px);
        }
        
        .metrics-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; margin-bottom: 25px; 
        }
        .metric-card { 
            background: rgba(42, 42, 60, 0.95); border-radius: 15px; padding: 25px; 
            border: 1px solid rgba(107, 72, 255, 0.3); text-align: center; 
            transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .metric-card:hover { transform: translateY(-5px); }
        .metric-card::before { 
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; 
            background: linear-gradient(90deg, #6b48ff, #ff6b48); 
        }
        .metric-value { font-size: 32px; font-weight: bold; color: #6b48ff; margin-bottom: 8px; }
        .metric-label { font-size: 14px; color: rgba(255, 255, 255, 0.8); }
        .metric-change { font-size: 12px; margin-top: 5px; }
        .change-positive { color: #28a745; }
        .change-negative { color: #dc3545; }
        
        .analytics-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); 
            gap: 25px; margin-bottom: 25px; 
        }
        .chart-card { 
            background: rgba(42, 42, 60, 0.95); border-radius: 15px; padding: 25px; 
            border: 1px solid rgba(107, 72, 255, 0.3); transition: all 0.3s ease;
        }
        .chart-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(107, 72, 255, 0.2); }
        .chart-title { font-size: 20px; font-weight: 600; color: #fff; margin-bottom: 20px; }
        
        .insights-section {
            background: rgba(42, 42, 60, 0.95); border-radius: 15px; padding: 25px;
            border: 1px solid rgba(107, 72, 255, 0.3); margin-bottom: 25px;
        }
        .insights-title { font-size: 22px; font-weight: 600; color: #6b48ff; margin-bottom: 20px; }
        .insight-item {
            display: flex; align-items: center; padding: 15px; border-radius: 8px;
            background: rgba(255, 255, 255, 0.05); margin-bottom: 15px;
        }
        .insight-icon { font-size: 24px; margin-right: 15px; }
        .insight-text { flex: 1; }
        .insight-value { font-weight: bold; color: #6b48ff; }
        
        .loading { text-align: center; padding: 40px; }
        .loading-spinner { 
            width: 40px; height: 40px; border: 4px solid rgba(107, 72, 255, 0.3); 
            border-top: 4px solid #6b48ff; border-radius: 50%; 
            animation: spin 1s linear infinite; margin: 0 auto 15px; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar { width: 70px; padding: 15px; }
            .sidebar h3, .sidebar ul li a span { display: none; }
            .sidebar ul li a { justify-content: center; }
            .content { margin-left: 70px; padding: 15px; }
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .filters { justify-content: center; flex-wrap: wrap; }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .analytics-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo" onclick="window.location.href='index.html'">ETHER-EYE</div>
        <h3>Main Navigation</h3>
        <ul>
            <li><a href="dashboard.html" class="dashboard"><span>Dashboard</span></a></li>
            <li><a href="wallets.html" class="wallets"><span>Wallets</span></a></li>
            <li><a href="traces.html" class="traces"><span>Traces</span></a></li>
            <li><a href="analytics.html" class="analytics active"><span>Analytics</span></a></li>
        </ul>
        <h3>Advanced Tools</h3>
        <ul>
            <li><a href="explorer.html" class="explorer"><span>Explorer</span></a></li>
            <li><a href="spider-map.html" class="spider-map"><span>Spider Map</span></a></li>
            <li><a href="settings.html" class="settings"><span>Settings</span></a></li>
        </ul>
    </div>
    <div class="content">
        <div class="header">
            <h1>üìä Advanced Analytics Dashboard</h1>
            <div class="filters">
                <button class="filter-btn active" onclick="updatePeriod('1h')">1H</button>
                <button class="filter-btn" onclick="updatePeriod('24h')">24H</button>
                <button class="filter-btn" onclick="updatePeriod('7d')">7D</button>
                <button class="filter-btn" onclick="updatePeriod('30d')">30D</button>
                <button class="filter-btn" onclick="refreshData()" style="background: rgba(40, 167, 69, 0.3);">üîÑ Refresh</button>
            </div>
        </div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="avgGasPrice">...</div>
                <div class="metric-label">‚õΩ Avg Gas Price (gwei)</div>
                <div class="metric-change change-positive" id="gasPriceChange">Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="totalVolume">...</div>
                <div class="metric-label">üí∞ 24h Volume</div>
                <div class="metric-change change-positive" id="volumeChange">Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="activeAddresses">...</div>
                <div class="metric-label">üë• Active Addresses</div>
                <div class="metric-change change-positive" id="addressesChange">Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="networkUtilization">...</div>
                <div class="metric-label">üåê Network Utilization</div>
                <div class="metric-change change-negative" id="utilizationChange">Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="totalTransactions">...</div>
                <div class="metric-label">‚ö° Total Transactions</div>
                <div class="metric-change change-positive" id="transactionsChange">Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="ethPrice">...</div>
                <div class="metric-label">üíé ETH Price (USD)</div>
                <div class="metric-change change-positive" id="ethPriceChange">Loading...</div>
            </div>
        </div>
        
        <div class="insights-section">
            <h3 class="insights-title">üîç AI-Powered Market Insights</h3>
            <div id="insightsList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Analyzing blockchain data...</p>
                </div>
            </div>
        </div>
        <div class="analytics-grid">
            <div class="chart-card">
                <h3 class="chart-title">üî• Gas Usage Trends</h3>
                <canvas id="gasChart" height="300"></canvas>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">üí∞ Transaction Volume</h3>
                <canvas id="volumeChart" height="300"></canvas>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">üåê Network Activity</h3>
                <canvas id="activityChart" height="300"></canvas>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">üìä Top Contracts</h3>
                <canvas id="contractsChart" height="300"></canvas>
            </div>
        </div>
    </div>
    <script>
        let charts = {};
        let apiClient = null;
        let currentPeriod = '24h';
        
        // Initialize
        window.addEventListener('load', async () => {
            if (window.ethereyeApi) {
                apiClient = window.ethereyeApi;
                console.log('‚úÖ API Client connected');
            }
            
            await initAnalytics();
            
            // Auto-refresh every 2 minutes
            setInterval(refreshData, 2 * 60 * 1000);
        });
        
        async function initAnalytics() {
            showLoading();
            createCharts();
            await loadMetrics();
            await loadInsights();
        }
        
        function showLoading() {
            const elements = ['avgGasPrice', 'totalVolume', 'activeAddresses', 'networkUtilization', 'totalTransactions', 'ethPrice'];
            elements.forEach(id => {
                document.getElementById(id).innerHTML = '<div style="display:inline-block; width:20px; height:20px; border:2px solid rgba(107,72,255,0.3); border-top:2px solid #6b48ff; border-radius:50%; animation:spin 1s linear infinite;"></div>';
            });
        }
        
        function createCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#fff' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            };
            
            charts.gas = new Chart(document.getElementById('gasChart'), {
                type: 'line',
                data: {
                    labels: generateTimeLabels(currentPeriod),
                    datasets: [{
                        label: 'Gas Price (gwei)',
                        data: generateGasData(),
                        borderColor: '#6b48ff',
                        backgroundColor: 'rgba(107, 72, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
            
            charts.volume = new Chart(document.getElementById('volumeChart'), {
                type: 'bar',
                data: {
                    labels: generateTimeLabels(currentPeriod),
                    datasets: [{
                        label: 'Volume (ETH)',
                        data: generateVolumeData(),
                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                        borderColor: '#28a745',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });
            
            charts.activity = new Chart(document.getElementById('activityChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Transfers', 'DEX Trades', 'DeFi', 'NFT', 'Other'],
                    datasets: [{
                        data: [35, 25, 20, 15, 5],
                        backgroundColor: ['#6b48ff', '#28a745', '#ffc107', '#dc3545', '#17a2b8'],
                        borderColor: '#2a2a3c',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff', padding: 15 }
                        }
                    }
                }
            });
            
            charts.contracts = new Chart(document.getElementById('contractsChart'), {
                type: 'bar',
                data: {
                    labels: ['Uniswap V3', 'USDT Contract', 'USDC Contract', 'Wrapped ETH', 'OpenSea'],
                    datasets: [{
                        label: 'Daily Interactions',
                        data: [12500, 8200, 7100, 5800, 4200],
                        backgroundColor: 'rgba(255, 107, 72, 0.8)',
                        borderColor: '#ff6b48',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y'
                }
            });
        }
        
        async function loadMetrics() {
            try {
                let gasPrice, volume, addresses, utilization, transactions, ethPrice;
                
                if (apiClient) {
                    try {
                        // Try to get real data from API
                        const gasData = await apiClient.getLiveGas();
                        gasPrice = gasData.standard || (15 + Math.random() * 10);
                        
                        const priceData = await apiClient.getLiveCryptoPrices('ethereum', 'usd');
                        ethPrice = priceData.ethereum?.usd || (2500 + Math.random() * 500);
                        
                        // Simulate other metrics (would come from API in real implementation)
                        volume = (2.4 + Math.random() * 0.8).toFixed(1);
                        addresses = (1.2 + Math.random() * 0.3).toFixed(1);
                        utilization = (75 + Math.random() * 15).toFixed(0);
                        transactions = Math.floor(180000 + Math.random() * 50000);
                    } catch (error) {
                        console.warn('API calls failed, using demo data:', error);
                        // Fallback to demo data
                        gasPrice = 15 + Math.random() * 10;
                        ethPrice = 2500 + Math.random() * 500;
                        volume = (2.4 + Math.random() * 0.8).toFixed(1);
                        addresses = (1.2 + Math.random() * 0.3).toFixed(1);
                        utilization = (75 + Math.random() * 15).toFixed(0);
                        transactions = Math.floor(180000 + Math.random() * 50000);
                    }
                } else {
                    // Demo data
                    gasPrice = 15 + Math.random() * 10;
                    ethPrice = 2500 + Math.random() * 500;
                    volume = (2.4 + Math.random() * 0.8).toFixed(1);
                    addresses = (1.2 + Math.random() * 0.3).toFixed(1);
                    utilization = (75 + Math.random() * 15).toFixed(0);
                    transactions = Math.floor(180000 + Math.random() * 50000);
                }
                
                // Update UI
                document.getElementById('avgGasPrice').textContent = Math.round(gasPrice);
                document.getElementById('totalVolume').textContent = `$${volume}B`;
                document.getElementById('activeAddresses').textContent = `${addresses}M`;
                document.getElementById('networkUtilization').textContent = `${utilization}%`;
                document.getElementById('totalTransactions').textContent = transactions.toLocaleString();
                document.getElementById('ethPrice').textContent = `$${Math.round(ethPrice).toLocaleString()}`;
                
                // Update change indicators
                updateChangeIndicators();
                
            } catch (error) {
                console.error('Failed to load metrics:', error);
                showErrorState();
            }
        }
        
        function updateChangeIndicators() {
            const changes = {
                gasPriceChange: (Math.random() - 0.5) * 20,
                volumeChange: (Math.random() - 0.3) * 15,
                addressesChange: (Math.random() - 0.2) * 8,
                utilizationChange: (Math.random() - 0.4) * 10,
                transactionsChange: (Math.random() - 0.1) * 12,
                ethPriceChange: (Math.random() - 0.4) * 8
            };
            
            Object.entries(changes).forEach(([id, change]) => {
                const element = document.getElementById(id);
                const isPositive = change > 0;
                element.className = `metric-change ${isPositive ? 'change-positive' : 'change-negative'}`;
                element.textContent = `${isPositive ? '+' : ''}${change.toFixed(2)}%`;
            });
        }
        
        async function loadInsights() {
            const insightsList = document.getElementById('insightsList');
            
            // Simulate loading
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const insights = [
                {
                    icon: 'üî•',
                    text: 'Gas prices are trending upward due to increased DeFi activity',
                    value: '+12% vs yesterday'
                },
                {
                    icon: 'üí∞',
                    text: 'DEX trading volume reached new weekly high',
                    value: '$847M in 24h'
                },
                {
                    icon: 'üéÜ',
                    text: 'NFT marketplace activity shows strong momentum',
                    value: '2,134 unique traders'
                },
                {
                    icon: '‚ö°',
                    text: 'Network congestion expected during US trading hours',
                    value: 'Peak: 4-8 PM EST'
                },
                {
                    icon: 'üìà',
                    text: 'ETH/USD correlation with traditional markets weakening',
                    value: '0.73 correlation'
                }
            ];
            
            insightsList.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-icon">${insight.icon}</div>
                    <div class="insight-text">${insight.text}</div>
                    <div class="insight-value">${insight.value}</div>
                </div>
            `).join('');
        }
        
        function generateTimeLabels(period) {
            const now = new Date();
            const labels = [];
            
            switch(period) {
                case '1h':
                    for(let i = 11; i >= 0; i--) {
                        const time = new Date(now.getTime() - i * 5 * 60000);
                        labels.push(time.getHours() + ':' + time.getMinutes().toString().padStart(2, '0'));
                    }
                    break;
                case '24h':
                    for(let i = 23; i >= 0; i--) {
                        const time = new Date(now.getTime() - i * 60 * 60000);
                        labels.push(time.getHours() + ':00');
                    }
                    break;
                case '7d':
                    for(let i = 6; i >= 0; i--) {
                        const date = new Date(now.getTime() - i * 24 * 60 * 60000);
                        labels.push(date.toLocaleDateString('en', {weekday: 'short'}));
                    }
                    break;
                case '30d':
                    for(let i = 29; i >= 0; i--) {
                        const date = new Date(now.getTime() - i * 24 * 60 * 60000);
                        labels.push(date.getDate().toString());
                    }
                    break;
            }
            
            return labels;
        }
        
        function generateGasData() {
            const basePrice = 15;
            const data = [];
            for(let i = 0; i < 24; i++) {
                data.push(basePrice + Math.random() * 20 + Math.sin(i * 0.5) * 5);
            }
            return data;
        }
        
        function generateVolumeData() {
            const data = [];
            for(let i = 0; i < 24; i++) {
                data.push(Math.random() * 1000 + 200 + Math.sin(i * 0.3) * 100);
            }
            return data;
        }
        
        function updatePeriod(period) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(period.toLowerCase())) {
                    btn.classList.add('active');
                }
            });
            
            currentPeriod = period;
            
            // Update chart labels and data
            const newLabels = generateTimeLabels(period);
            
            Object.values(charts).forEach(chart => {
                if (chart && chart.data && chart.data.labels) {
                    chart.data.labels = newLabels;
                    if (chart.data.datasets[0]) {
                        if (chart.config.type === 'line') {
                            chart.data.datasets[0].data = generateGasData();
                        } else if (chart.config.type === 'bar' && chart.canvas.id === 'volumeChart') {
                            chart.data.datasets[0].data = generateVolumeData();
                        }
                    }
                    chart.update();
                }
            });
        }
        
        async function refreshData() {
            console.log('üîÑ Refreshing analytics data...');
            showLoading();
            await loadMetrics();
            updatePeriod(currentPeriod);
        }
        
        function showErrorState() {
            const elements = ['avgGasPrice', 'totalVolume', 'activeAddresses', 'networkUtilization', 'totalTransactions', 'ethPrice'];
            elements.forEach(id => {
                document.getElementById(id).textContent = 'Error';
            });
        }
    </script>
</body>
</html>