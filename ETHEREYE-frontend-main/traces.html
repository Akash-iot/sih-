<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ETHER-EYE | Transaction Traces</title>
    <meta name="description" content="Interactive blockchain transaction flow visualization with network analysis" />
    
    <!-- Include vis.js Network -->
    <link href="js/vis/vis-network.min.css" rel="stylesheet" type="text/css" />
    <script src="js/vis/vis-network.min.js"></script>
    
    <!-- Include API Client -->
    <script src="js/api-client.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; display: flex; min-height: 100vh; }
        
        .sidebar { 
            width: 220px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 20px; height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar .logo { display: flex; align-items: center; margin-bottom: 30px; font-size: 24px; font-weight: bold; color: white; }
        .sidebar .logo::before { content: "üî¨"; margin-right: 12px; font-size: 28px; }
        .sidebar h3 { font-size: 14px; text-transform: uppercase; margin: 20px 0 10px 0; color: rgba(255,255,255,0.7); letter-spacing: 1px; }
        .sidebar ul { list-style: none; }
        .sidebar ul li { margin-bottom: 8px; }
        .sidebar ul li a { 
            display: flex; align-items: center; color: rgba(255,255,255,0.9); text-decoration: none; 
            padding: 12px 15px; border-radius: 8px; transition: all 0.3s ease; font-size: 14px;
        }
        .sidebar ul li a:hover, .sidebar ul li a.active { 
            background: rgba(255,255,255,0.15); color: white; transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .sidebar ul li a::before { margin-right: 12px; font-size: 18px; }
        .sidebar ul li a.dashboard::before { content: "üìä"; }
        .sidebar ul li a.wallets::before { content: "üëõ"; }
        .sidebar ul li a.traces::before { content: "üîç"; }
        .sidebar ul li a.analytics::before { content: "üìà"; }
        .sidebar ul li a.spider-map::before { content: "üï∏Ô∏è"; }
        .sidebar ul li a.explorer::before { content: "üåê"; }
        .sidebar ul li a.settings::before { content: "‚öôÔ∏è"; }
        
        .content { margin-left: 220px; padding: 20px; flex: 1; background-color: #f8f9fa; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; 
            background: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        header h1 { font-size: 28px; font-weight: 700; color: #333; display: flex; align-items: center; }
        header h1::before { content: "üîç"; margin-right: 15px; font-size: 32px; }
        
        .search-container { display: flex; align-items: center; gap: 15px; }
        .search-wrapper { position: relative; }
        .search-input { 
            padding: 12px 15px 12px 45px; border: 2px solid #e9ecef; border-radius: 25px; width: 350px; 
            font-size: 14px; outline: none; transition: all 0.3s ease; background: #f8f9fa;
        }
        .search-input:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); background: white; }
        .search-wrapper::before { 
            content: "üîç"; position: absolute; left: 15px; top: 50%; transform: translateY(-50%); 
            color: #666; font-size: 16px; 
        }
        .search-container button { 
            padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;
            transition: all 0.3s ease; min-width: 80px;
        }
        .search-container button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); }
        
        .card { 
            background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            margin-bottom: 20px; overflow: hidden; border: 1px solid rgba(0,0,0,0.05);
        }
        .card-header { 
            padding: 20px 25px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
            border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; 
        }
        .card-header h3 { font-size: 18px; font-weight: 600; color: #333; display: flex; align-items: center; }
        .card-header h3::before { margin-right: 10px; font-size: 20px; }
        .card-content { padding: 25px; }
        
        .status-indicator { 
            padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; 
            text-transform: uppercase; display: flex; align-items: center; gap: 6px;
        }
        .status-connected { background: #d4edda; color: #155724; }
        .status-connected::before { content: "‚úÖ"; }
        .status-disconnected { background: #f8d7da; color: #721c24; }
        .status-disconnected::before { content: "‚ùå"; }
        .status-testing { background: #fff3cd; color: #856404; }
        .status-testing::before { content: "‚è≥"; }
        
        /* Network Visualization Styles */
        #networkVisualization { 
            height: 500px; border: 2px solid #e9ecef; border-radius: 8px; background: #fafbfc;
            position: relative; overflow: hidden;
        }
        
        .visualization-placeholder { 
            height: 500px; display: flex; align-items: center; justify-content: center; 
            text-align: center; color: #6c757d; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #dee2e6; border-radius: 8px; position: relative;
        }
        .visualization-placeholder::before {
            content: ""; position: absolute; top: 20px; right: 20px; width: 60px; height: 60px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="20" r="8" fill="%23667eea"/><circle cx="80" cy="50" r="6" fill="%23764ba2"/><circle cx="20" cy="80" r="7" fill="%23667eea"/><line x1="50" y1="20" x2="80" y2="50" stroke="%23667eea" stroke-width="2"/><line x1="50" y1="20" x2="20" y2="80" stroke="%23764ba2" stroke-width="2"/></svg>');
            opacity: 0.3;
        }
        
        .visualization-controls {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 10px 15px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
        }
        .visualization-controls button {
            margin-right: 8px; padding: 6px 12px; border: 1px solid #dee2e6; background: white;
            border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s ease;
        }
        .visualization-controls button:hover {
            background: #667eea; color: white; border-color: #667eea;
        }
        
        .network-legend {
            position: absolute; bottom: 15px; right: 15px; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
            font-size: 12px; min-width: 200px;
        }
        .legend-item {
            display: flex; align-items: center; margin-bottom: 8px; gap: 10px;
        }
        .legend-color {
            width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Enhanced Tabs */
        .tabs { margin-top: 30px; }
        .tab-buttons { 
            display: flex; gap: 0; margin-bottom: 20px; background: white; 
            border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .tab-button { 
            padding: 15px 25px; background: transparent; border: none; cursor: pointer; 
            font-size: 14px; font-weight: 600; transition: all 0.3s ease; position: relative;
            color: #6c757d; min-width: 140px;
        }
        .tab-button.active { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
        }
        .tab-button::before { margin-right: 8px; }
        .tab-button[data-tab="history"]::before { content: "üìú"; }
        .tab-button[data-tab="anomalies"]::before { content: "ü§ñ"; }
        .tab-button[data-tab="saved"]::before { content: "üíæ"; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Enhanced Trace Items */
        .trace-item { 
            display: flex; align-items: center; padding: 20px; border-bottom: 1px solid #f1f3f4; 
            gap: 20px; transition: all 0.2s ease; background: white; margin-bottom: 8px;
            border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .trace-item:hover { 
            transform: translateX(5px); box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
        }
        .trace-item .icon { 
            font-size: 28px; min-width: 40px; text-align: center; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 12px; padding: 8px;
        }
        .trace-item .details { flex: 1; }
        .trace-item .details h4 { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 6px; }
        .trace-item .details p { font-size: 13px; color: #666; margin: 3px 0; }
        .trace-item .value { 
            font-size: 16px; font-weight: 700; color: #333; min-width: 100px; 
            text-align: right; padding: 8px 12px; background: #f8f9fa; border-radius: 6px;
        }
        .trace-item .actions { display: flex; gap: 8px; }
        .trace-item .actions button { 
            padding: 8px 16px; border: 1px solid #dee2e6; border-radius: 6px; 
            cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s ease;
            background: white;
        }
        .trace-item .actions button:hover { 
            background: #667eea; color: white; border-color: #667eea; 
            transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .error-message, .success-message, .info-message { 
            padding: 15px 20px; border-radius: 8px; margin: 15px 0; font-weight: 500;
            display: flex; align-items: center; gap: 10px;
        }
        .error-message { color: #721c24; background: #f8d7da; border-left: 4px solid #dc3545; }
        .error-message::before { content: "‚ùå"; }
        .success-message { color: #155724; background: #d4edda; border-left: 4px solid #28a745; }
        .success-message::before { content: "‚úÖ"; }
        .info-message { color: #0c5460; background: #d1ecf1; border-left: 4px solid #17a2b8; }
        .info-message::before { content: "‚ÑπÔ∏è"; }
        
        /* Loading Animation */
        .loading-spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">ETHER-EYE</div>
        <h3>Navigation</h3>
        <ul>
            <li><a href="dashboard.html" class="dashboard">Dashboard</a></li>
            <li><a href="wallets.html" class="wallets">Wallets</a></li>
            <li><a href="traces.html" class="traces active">Transaction Traces</a></li>
            <li><a href="analytics.html" class="analytics">Analytics</a></li>
            <li><a href="spider-map.html" class="spider-map">Spider Map</a></li>
            <li><a href="explorer.html" class="explorer">Explorer</a></li>
            <li><a href="settings.html" class="settings">Settings</a></li>
        </ul>
    </div>

    <div class="content">
        <header>
            <h1>Transaction Traces</h1>
            <div class="search-container">
                <div class="search-wrapper">
                    <input type="text" id="searchQuery" class="search-input" placeholder="Enter address or transaction hash...">
                </div>
                <button onclick="handleSearch()">Trace</button>
                <button onclick="testConnection()">Test API</button>
                <button onclick="generateSampleData()">Demo</button>
            </div>
        </header>

        <!-- API Connection Status -->
        <div class="card">
            <div class="card-header">
                <h3 style="--icon: 'üîó';">API Connection Status</h3>
                <span id="connectionStatus" class="status-indicator status-testing">Checking...</span>
            </div>
            <div class="card-content">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 15px;">
                    <div><strong>Backend Server:</strong> <span id="serverUrl">http://localhost:8000</span></div>
                    <div><strong>Last Checked:</strong> <span id="lastChecked">Never</span></div>
                    <div><strong>Status:</strong> <span id="serverStatus">Checking...</span></div>
                </div>
                <div id="connectionMessage"></div>
            </div>
        </div>

        <!-- Interactive Network Visualization -->
        <div class="card">
            <div class="card-header">
                <h3 style="--icon: 'üåê';">Interactive Transaction Flow Visualization</h3>
            </div>
            <div class="card-content">
                <div id="networkContainer" class="visualization-placeholder">
                    <div id="networkVisualization" style="display: none;"></div>
                    <div id="placeholderContent">
                        <h3>üîç Interactive Transaction Flow Visualization</h3>
                        <p>Enter an address or transaction hash to visualize blockchain relationships</p>
                        <p><strong>‚ú® Features:</strong> Drag nodes, zoom, click for details</p>
                        <div style="margin-top: 20px;">
                            <button onclick="generateSampleData()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                üéÆ Try Interactive Demo
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Visualization Controls -->
                <div class="visualization-controls" id="vizControls" style="display: none;">
                    <button onclick="fitNetwork()">üîç Fit</button>
                    <button onclick="resetZoom()">‚Üª Reset</button>
                    <button onclick="togglePhysics()">‚öôÔ∏è Physics</button>
                    <button onclick="exportNetwork()">üì• Export</button>
                </div>
                
                <!-- Network Legend -->
                <div class="network-legend" id="networkLegend" style="display: none;">
                    <h4 style="margin-bottom: 10px;">Node Types</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #667eea;"></div>
                        <span>Origin Address</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #28a745;"></div>
                        <span>Regular Address</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffc107;"></div>
                        <span>Exchange</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dc3545;"></div>
                        <span>High Risk</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #6f42c1;"></div>
                        <span>Contract</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Tabs -->
        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="history">Trace History</button>
                <button class="tab-button" data-tab="anomalies">ML Analysis</button>
                <button class="tab-button" data-tab="saved">Saved Traces</button>
            </div>

            <div class="tab-content active" id="history">
                <div class="card">
                    <div class="card-content" id="historyContent">
                        <div style="text-align: center; padding: 60px 20px;">
                            <h3 style="color: #667eea; margin-bottom: 10px;">üìú No trace history yet</h3>
                            <p>Search for addresses or transaction hashes to build your trace history</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="anomalies">
                <div class="card">
                    <div class="card-content" id="anomaliesContent">
                        <div style="text-align: center; padding: 60px 20px;">
                            <h3 style="color: #667eea; margin-bottom: 10px;">ü§ñ Advanced ML Analysis</h3>
                            <p>Machine learning analysis results will appear here</p>
                            <p><small>Clustering, anomaly detection, and risk scoring from ETHEREYE ML backend</small></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="saved">
                <div class="card">
                    <div class="card-content" id="savedContent">
                        <div style="text-align: center; padding: 60px 20px;">
                            <h3 style="color: #667eea; margin-bottom: 10px;">üíæ No saved traces</h3>
                            <p>Save interesting transaction traces for future reference</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let traceHistory = [];
        let mlAnalysisResults = [];
        let savedTraces = [];
        let apiClient = null;
        let network = null;
        let networkData = { nodes: new vis.DataSet([]), edges: new vis.DataSet([]) };
        let physicsEnabled = true;

        // Initialize API client and network
        window.addEventListener('load', () => {
            if (window.ethereyeApi) {
                apiClient = window.ethereyeApi;
                testConnection();
            } else {
                updateConnectionStatus(false, 'API client not loaded');
            }
            
            initializeNetwork();
        });

        // Initialize vis.js network
        function initializeNetwork() {
            const container = document.getElementById('networkVisualization');
            
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 20,
                    font: { size: 14, color: '#343a40' },
                    borderWidth: 3,
                    shadow: { enabled: true, color: 'rgba(0,0,0,0.2)', size: 10 }
                },
                edges: {
                    width: 2,
                    color: { color: '#667eea', highlight: '#764ba2' },
                    arrows: { to: { enabled: true, scaleFactor: 1.2 } },
                    smooth: { enabled: true, type: 'continuous' },
                    shadow: { enabled: true }
                },
                physics: {
                    enabled: true,
                    stabilization: { iterations: 150 },
                    barnesHut: {
                        gravitationalConstant: -8000,
                        centralGravity: 0.3,
                        springLength: 120
                    }
                },
                interaction: {
                    dragNodes: true,
                    dragView: true,
                    zoomView: true,
                    hover: true
                },
                layout: {
                    improvedLayout: true,
                    randomSeed: 42
                }
            };

            network = new vis.Network(container, networkData, options);
            
            // Event listeners
            network.on('click', onNodeClick);
            network.on('hoverNode', onNodeHover);
            network.on('blurNode', onNodeBlur);
            network.on('stabilizationIterationsDone', () => {
                network.setOptions({ physics: { enabled: false } });
                physicsEnabled = false;
            });
        }

        // Network event handlers
        function onNodeClick(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const node = networkData.nodes.get(nodeId);
                if (node) {
                    showNodeDetails(node);
                }
            }
        }

        function onNodeHover(params) {
            const nodeId = params.node;
            const node = networkData.nodes.get(nodeId);
            if (node) {
                network.canvas.body.container.style.cursor = 'pointer';
            }
        }

        function onNodeBlur(params) {
            network.canvas.body.container.style.cursor = 'default';
        }

        // Show node details
        function showNodeDetails(node) {
            const details = `
                <div class="info-message">
                    <strong>Address:</strong> ${node.id}<br>
                    <strong>Label:</strong> ${node.label}<br>
                    <strong>Type:</strong> ${node.type || 'Unknown'}<br>
                    <strong>Balance:</strong> ${node.balance || 'N/A'}<br>
                    <strong>Risk Level:</strong> ${node.risk || 'Unknown'}
                </div>
            `;
            
            document.getElementById('connectionMessage').innerHTML = details;
            setTimeout(() => {
                if (document.getElementById('connectionMessage').innerHTML === details) {
                    testConnection(); // Restore connection info
                }
            }, 5000);
        }

        // Network control functions
        function fitNetwork() {
            if (network) {
                network.fit({ animation: { duration: 1000, easingFunction: 'easeInOutQuad' } });
            }
        }

        function resetZoom() {
            if (network) {
                network.moveTo({ scale: 1.0, animation: { duration: 1000 } });
            }
        }

        function togglePhysics() {
            if (network) {
                physicsEnabled = !physicsEnabled;
                network.setOptions({ physics: { enabled: physicsEnabled } });
                
                const button = document.querySelector('[onclick="togglePhysics()"]');
                button.textContent = physicsEnabled ? '‚è∏Ô∏è Physics' : '‚ñ∂Ô∏è Physics';
            }
        }

        function exportNetwork() {
            if (network) {
                const canvas = network.canvas.frame.canvas;
                const link = document.createElement('a');
                link.download = `ethereye-trace-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }
        }

        // Generate sample data for demonstration
        function generateSampleData() {
            const sampleNodes = [
                { id: '0x742d4c20...e4f1', label: 'Origin', type: 'origin', balance: '1,250.5 ETH', risk: 'Low', 
                  color: { background: '#667eea', border: '#5a67d8' } },
                { id: '0x1a2b3c4d...f12', label: 'Exchange', type: 'exchange', balance: '15,000 ETH', risk: 'Low',
                  color: { background: '#ffc107', border: '#e0a800' } },
                { id: '0x9876543...210', label: 'High Risk', type: 'suspicious', balance: '0.1 ETH', risk: 'High',
                  color: { background: '#dc3545', border: '#c82333' } },
                { id: '0xabcdef...bcd', label: 'Contract', type: 'contract', balance: '500 ETH', risk: 'Medium',
                  color: { background: '#6f42c1', border: '#59359a' } },
                { id: '0x123456...789', label: 'Regular', type: 'regular', balance: '25.8 ETH', risk: 'Low',
                  color: { background: '#28a745', border: '#1e7e34' } },
                { id: '0xfedcba...321', label: 'Mixer', type: 'mixer', balance: '2.1 ETH', risk: 'Critical',
                  color: { background: '#fd7e14', border: '#e8590c' } }
            ];

            const sampleEdges = [
                { from: '0x742d4c20...e4f1', to: '0x1a2b3c4d...f12', label: '50 ETH', width: 4,
                  color: { color: '#28a745' } },
                { from: '0x742d4c20...e4f1', to: '0x123456...789', label: '10.5 ETH', width: 3,
                  color: { color: '#667eea' } },
                { from: '0x1a2b3c4d...f12', to: '0x9876543...210', label: '0.5 ETH', width: 2,
                  color: { color: '#ffc107' } },
                { from: '0x123456...789', to: '0xabcdef...bcd', label: '5 ETH', width: 3,
                  color: { color: '#6f42c1' } },
                { from: '0x9876543...210', to: '0xfedcba...321', label: '0.1 ETH', width: 1,
                  color: { color: '#dc3545' } }
            ];

            // Update network data
            networkData.nodes.clear();
            networkData.edges.clear();
            networkData.nodes.add(sampleNodes);
            networkData.edges.add(sampleEdges);

            // Show network
            showNetworkVisualization({
                query: '0x742d4c20...e4f1',
                type: 'address',
                nodes: sampleNodes.length,
                edges: sampleEdges.length,
                timestamp: new Date().toLocaleString()
            });

            // Add to history
            traceHistory.unshift({
                hash: '0x742d4c20bcb6ad1651a07b68b4f5c7b5d9c3e4f1',
                type: 'address',
                timestamp: new Date().toLocaleString(),
                status: 'success (demo)'
            });
            updateTraceHistory();

            // Show success message
            document.getElementById('connectionMessage').innerHTML = `
                <div class="success-message">
                    <strong>Demo Data Loaded!</strong><br>
                    Interactive network visualization with ${sampleNodes.length} nodes and ${sampleEdges.length} connections.<br>
                    Click nodes for details, drag to explore, use controls to navigate.
                </div>
            `;
        }

        // Show network visualization
        function showNetworkVisualization(data) {
            document.getElementById('placeholderContent').style.display = 'none';
            document.getElementById('networkVisualization').style.display = 'block';
            document.getElementById('vizControls').style.display = 'flex';
            document.getElementById('networkLegend').style.display = 'block';

            if (network) {
                setTimeout(() => {
                    network.redraw();
                    fitNetwork();
                }, 100);
            }
        }

        // Test API connection
        async function testConnection() {
            const statusElement = document.getElementById('connectionStatus');
            const messageElement = document.getElementById('connectionMessage');
            const lastCheckedElement = document.getElementById('lastChecked');
            const serverStatusElement = document.getElementById('serverStatus');
            
            try {
                statusElement.innerHTML = 'Testing...';
                statusElement.className = 'status-indicator status-testing';
                serverStatusElement.textContent = 'Connecting...';
                
                const response = await apiClient.healthCheck();
                updateConnectionStatus(true, 'Connected successfully');
                
                const apiInfo = await apiClient.getApiInfo();
                messageElement.innerHTML = `
                    <div class="success-message">
                        <strong>üéâ Connected to ETHEREYE Backend!</strong><br>
                        <strong>Server:</strong> ${apiInfo.name || 'ETHEREYE API'}<br>
                        <strong>Version:</strong> ${apiInfo.version || 'Unknown'}<br>
                        <strong>Status:</strong> ${apiInfo.status || 'Running'}<br>
                        <strong>ML Services:</strong> Available at /api/v1/ml/
                    </div>
                `;
                serverStatusElement.textContent = 'Connected & Ready';
                
            } catch (error) {
                updateConnectionStatus(false, `Connection failed: ${error.message}`);
                messageElement.innerHTML = `
                    <div class="error-message">
                        <strong>Connection Failed:</strong> ${error.message}<br>
                        <strong>Solution:</strong> Make sure the backend server is running:<br>
                        <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px;">
                            cd ../backend && python -m uvicorn simple_main:app --reload
                        </code>
                    </div>
                `;
                serverStatusElement.textContent = 'Disconnected';
            }
            
            lastCheckedElement.textContent = new Date().toLocaleTimeString();
        }

        function updateConnectionStatus(connected, message) {
            const statusElement = document.getElementById('connectionStatus');
            
            if (connected) {
                statusElement.innerHTML = 'Connected';
                statusElement.className = 'status-indicator status-connected';
            } else {
                statusElement.innerHTML = 'Disconnected';
                statusElement.className = 'status-indicator status-disconnected';
            }
        }

        // Input validation
        function isValidInput(input) {
            const addressRegex = /^0x[a-fA-F0-9]{40}$/;
            const txHashRegex = /^0x[a-fA-F0-9]{64}$/;
            return addressRegex.test(input) || txHashRegex.test(input);
        }

        // Handle search with network visualization
        async function handleSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            
            if (!query) {
                document.getElementById('placeholderContent').style.display = 'block';
                document.getElementById('networkVisualization').style.display = 'none';
                document.getElementById('vizControls').style.display = 'none';
                document.getElementById('networkLegend').style.display = 'none';
                return;
            }

            if (!isValidInput(query)) {
                document.getElementById('connectionMessage').innerHTML = `
                    <div class="error-message">
                        <strong>Invalid Input Format</strong><br>
                        Please enter a valid Ethereum address (42 chars) or transaction hash (66 chars)<br>
                        <strong>Example Address:</strong> 0x742d4c20bcb6ad1651a07b68b4f5c7b5d9c3e4f1<br>
                        <strong>Example Hash:</strong> 0x1234...abcd (64 hex characters)
                    </div>
                `;
                return;
            }

            // Show loading
            document.getElementById('connectionMessage').innerHTML = `
                <div class="info-message">
                    <div class="loading-spinner"></div>
                    <div style="margin-left: 15px;">
                        <strong>üîç Analyzing ${query.slice(0, 10)}...</strong><br>
                        Fetching data from ETHEREYE backend and generating network visualization...
                    </div>
                </div>
            `;

            try {
                const data = await fetchTraceData(query);
                
                // Generate network data from trace results
                const networkNodes = generateNetworkNodes(data);
                const networkEdges = generateNetworkEdges(data);
                
                // Update network
                networkData.nodes.clear();
                networkData.edges.clear();
                networkData.nodes.add(networkNodes);
                networkData.edges.add(networkEdges);
                
                showNetworkVisualization(data);
                
                // Update trace history
                traceHistory.unshift({
                    hash: query,
                    type: data.type,
                    timestamp: data.timestamp,
                    status: 'success'
                });
                traceHistory = traceHistory.slice(0, 10);
                updateTraceHistory();
                
                // Update ML analysis if available
                if (data.riskData || data.spiderData) {
                    mlAnalysisResults.unshift({
                        hash: query,
                        analysis: { spider: data.spiderData, risk: data.riskData },
                        timestamp: data.timestamp
                    });
                    mlAnalysisResults = mlAnalysisResults.slice(0, 5);
                    updateMLAnalysis();
                }

                document.getElementById('connectionMessage').innerHTML = `
                    <div class="success-message">
                        <strong>‚ú® Trace Analysis Complete!</strong><br>
                        <strong>Query:</strong> ${query}<br>
                        <strong>Type:</strong> ${data.type}<br>
                        <strong>Network:</strong> ${networkNodes.length} nodes, ${networkEdges.length} connections<br>
                        <strong>Time:</strong> ${data.timestamp}
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('connectionMessage').innerHTML = `
                    <div class="error-message">
                        <strong>‚ùå Trace Analysis Failed</strong><br>
                        <strong>Error:</strong> ${error.message}<br>
                        <button onclick="testConnection()" style="margin-top: 10px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üîÑ Test Connection
                        </button>
                    </div>
                `;
            }
        }

        // Fetch trace data from API
        async function fetchTraceData(query) {
            if (!apiClient) {
                throw new Error('API client not initialized');
            }

            const isTransaction = query.length === 66;
            
            try {
                let traceData, spiderData, riskData;
                
                if (isTransaction) {
                    traceData = await apiClient.getTransaction(query);
                } else {
                    traceData = await apiClient.getAddress(query);
                    try {
                        spiderData = await apiClient.getSpiderNetwork(query, { depth: 2, limit: 10 });
                        riskData = await apiClient.getRiskAnalysis(query);
                    } catch (e) {
                        // These endpoints might not exist yet
                        console.log('Advanced endpoints not available:', e.message);
                    }
                }

                return {
                    query: query,
                    type: isTransaction ? 'transaction' : 'address',
                    traceData: traceData,
                    spiderData: spiderData,
                    riskData: riskData,
                    timestamp: new Date().toLocaleString()
                };
                
            } catch (error) {
                // Fallback with sample data structure
                console.log('Using fallback data:', error.message);
                
                return {
                    query: query,
                    type: isTransaction ? 'transaction' : 'address',
                    traceData: {
                        address: query,
                        note: 'Connected to ETHEREYE API - generating sample network'
                    },
                    timestamp: new Date().toLocaleString()
                };
            }
        }

        // Generate network nodes from trace data
        function generateNetworkNodes(data) {
            const nodes = [];
            
            // Add origin node
            nodes.push({
                id: data.query,
                label: data.query.slice(0, 8) + '...',
                type: 'origin',
                balance: 'Unknown',
                risk: 'Unknown',
                color: { background: '#667eea', border: '#5a67d8' }
            });

            // Add related nodes (sample data for now)
            const relatedAddresses = [
                { suffix: 'abc123', type: 'regular', risk: 'Low', color: '#28a745' },
                { suffix: 'def456', type: 'exchange', risk: 'Low', color: '#ffc107' },
                { suffix: '789xyz', type: 'contract', risk: 'Medium', color: '#6f42c1' }
            ];

            relatedAddresses.forEach((addr, index) => {
                nodes.push({
                    id: `0x${addr.suffix}${'0'.repeat(34)}`,
                    label: `0x${addr.suffix}...`,
                    type: addr.type,
                    risk: addr.risk,
                    color: { background: addr.color, border: addr.color }
                });
            });

            return nodes;
        }

        // Generate network edges from trace data
        function generateNetworkEdges(data) {
            const edges = [];
            
            // Sample connections
            edges.push(
                { from: data.query, to: `0xabc123${'0'.repeat(34)}`, label: '10 ETH', width: 3 },
                { from: data.query, to: `0xdef456${'0'.repeat(34)}`, label: '5 ETH', width: 2 },
                { from: `0xabc123${'0'.repeat(34)}`, to: `0x789xyz${'0'.repeat(34)}`, label: '2 ETH', width: 2 }
            );

            return edges;
        }

        // Update functions for history and saved traces
        function updateTraceHistory() {
            const historyContent = document.getElementById('historyContent');
            
            if (traceHistory.length === 0) {
                historyContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <h3 style="color: #667eea; margin-bottom: 10px;">üìú No trace history yet</h3>
                        <p>Search for addresses or transaction hashes to build your trace history</p>
                    </div>
                `;
                return;
            }

            historyContent.innerHTML = traceHistory.map((item, index) => `
                <div class="trace-item">
                    <div class="icon">${item.type === 'transaction' ? 'üì§' : 'üëõ'}</div>
                    <div class="details">
                        <h4>${item.type === 'transaction' ? 'Transaction' : 'Address'} Trace</h4>
                        <p><strong>Hash:</strong> ${item.hash}</p>
                        <p><strong>Time:</strong> ${item.timestamp}</p>
                        <p><strong>Status:</strong> ${item.status}</p>
                    </div>
                    <div class="value">${item.type.toUpperCase()}</div>
                    <div class="actions">
                        <button onclick="saveTrace(${index})">üíæ Save</button>
                        <button onclick="viewTrace('${item.hash}')">üëÅÔ∏è View</button>
                    </div>
                </div>
            `).join('');
        }

        function updateMLAnalysis() {
            const anomaliesContent = document.getElementById('anomaliesContent');
            
            if (mlAnalysisResults.length === 0) {
                anomaliesContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <h3 style="color: #667eea; margin-bottom: 10px;">ü§ñ Advanced ML Analysis</h3>
                        <p>Machine learning analysis results will appear here</p>
                        <p><small>Clustering, anomaly detection, and risk scoring from ETHEREYE ML backend</small></p>
                    </div>
                `;
                return;
            }

            anomaliesContent.innerHTML = mlAnalysisResults.map(item => `
                <div class="trace-item">
                    <div class="icon">ü§ñ</div>
                    <div class="details">
                        <h4>ML Analysis Results</h4>
                        <p><strong>Address:</strong> ${item.hash}</p>
                        <p><strong>Analysis:</strong> Spider Network + Risk Assessment</p>
                        <p><strong>Time:</strong> ${item.timestamp}</p>
                    </div>
                    <div class="value">ML</div>
                    <div class="actions">
                        <button onclick="viewTrace('${item.hash}')">üëÅÔ∏è View</button>
                    </div>
                </div>
            `).join('');
        }

        function updateSavedTraces() {
            const savedContent = document.getElementById('savedContent');
            
            if (savedTraces.length === 0) {
                savedContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <h3 style="color: #667eea; margin-bottom: 10px;">üíæ No saved traces</h3>
                        <p>Save interesting transaction traces for future reference</p>
                    </div>
                `;
                return;
            }

            savedContent.innerHTML = savedTraces.map((item, index) => `
                <div class="trace-item">
                    <div class="icon">üíæ</div>
                    <div class="details">
                        <h4>Saved Trace</h4>
                        <p><strong>Hash:</strong> ${item.hash}</p>
                        <p><strong>Time:</strong> ${item.timestamp}</p>
                        <p><strong>Type:</strong> ${item.type}</p>
                    </div>
                    <div class="value">SAVED</div>
                    <div class="actions">
                        <button onclick="removeSavedTrace(${index})">üóëÔ∏è Remove</button>
                        <button onclick="viewTrace('${item.hash}')">üëÅÔ∏è View</button>
                    </div>
                </div>
            `).join('');
        }

        // Helper functions
        function saveTrace(index) {
            const trace = traceHistory[index];
            if (!savedTraces.some(t => t.hash === trace.hash)) {
                savedTraces.push(trace);
                updateSavedTraces();
                
                document.getElementById('connectionMessage').innerHTML = `
                    <div class="success-message">
                        <strong>‚úÖ Trace Saved Successfully!</strong><br>
                        Added to your saved traces collection.
                    </div>
                `;
                setTimeout(() => testConnection(), 3000);
            } else {
                document.getElementById('connectionMessage').innerHTML = `
                    <div class="info-message">
                        <strong>‚ÑπÔ∏è Already Saved</strong><br>
                        This trace is already in your saved collection.
                    </div>
                `;
                setTimeout(() => testConnection(), 3000);
            }
        }

        function removeSavedTrace(index) {
            savedTraces.splice(index, 1);
            updateSavedTraces();
            
            document.getElementById('connectionMessage').innerHTML = `
                <div class="success-message">
                    <strong>‚úÖ Trace Removed</strong><br>
                    Removed from your saved traces collection.
                </div>
            `;
            setTimeout(() => testConnection(), 3000);
        }

        async function viewTrace(hash) {
            document.getElementById('searchQuery').value = hash;
            await handleSearch();
        }

        // Tab switching
        const tabs = document.querySelectorAll('.tab-button');
        const contents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Search on Enter key
        const searchInput = document.getElementById('searchQuery');
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });

        // Initialize
        updateTraceHistory();
        updateMLAnalysis();
        updateSavedTraces();
    </script>
</body>
</html>
